{% extends 'tools/sidebar.html' %}

{% block title %}My Files{% endblock %}

{% block content %}
<div class="container mt-5">
    <!-- My Files Section -->
    <section class="form-section">
        <div class="href-target" id="my-files"></div>
        <h1>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder">
                <path d="M9 2H5a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-8l-2-2z"></path>
            </svg>
            My Files
        </h1>
        <p>Here are the files generated by your tools. You can download or delete them as needed.</p>

        <div class="folder-container">
            {% for tool_name, tool_data in output_files.items %}
            <div class="folder bg-light p-3 rounded shadow-sm mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h3>{{ tool_name }}</h3>
                    <div>
                        <!-- Zip Download -->
                        <a href="{% url 'download_folder' folder_path=tool_name %}" class="btn btn-sm btn-success me-2">
                            <i class="feather feather-download"></i> Download All
                        </a>
                        <!-- Delete Folder -->
                        <form method="post" action="{% url 'delete_folder' %}" style="display: inline;" onsubmit="return confirmDeleteFolder('{{ tool_name }}')">
                            {% csrf_token %}
                            <input type="hidden" name="folder_path" value="{{ tool_name }}">
                            <button type="submit" class="btn btn-sm btn-danger">
                                <i class="feather feather-trash-2"></i> Delete All
                            </button>
                        </form>
                    </div>
                </div>
                <!-- Render Directory Structure Recursively -->
                {% include 'tools/render_directory.html' with data=tool_data parent=tool_name %}
            </div>
            {% endfor %}
        </div>
    </section>
</div>

<script>
    function deleteFile(filePath, fileName) {
        if (confirm(`Are you sure you want to delete the file "${fileName}"?`)) {
            fetch("{% url 'delete_file' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: new URLSearchParams({ file_path: filePath })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    location.reload(); 
                } else {
                    alert(data.message || "Failed to delete the file.");
                }
            })
            .catch(error => {
                console.error("Error deleting file:", error);
                alert("An error occurred while trying to delete the file.");
            });
        }
    }

    function confirmDeleteFolder(folderName) {
        return confirm(`Are you sure you want to delete the folder "${folderName}" and all its contents?`);
    }
</script>
{% endblock %}
